<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<title>Plans</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Plans</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#_specification">Specification</a>
<ul class="sectlevel1">
<li><a href="#_interrupts">Interrupts</a></li>
<li><a href="#_cpu_state">CPU State</a></li>
<li><a href="#_instructions">Instructions</a>
<ul class="sectlevel2">
<li><a href="#_control_and_status_register_csr_instructions">Control and status register (CSR) instructions</a></li>
</ul>
</li>
<li><a href="#_exceptions">Exceptions</a></li>
<li><a href="#_interrupts_2">Interrupts</a></li>
</ul>
</li>
<li><a href="#_design">Design</a>
<ul class="sectlevel1">
<li><a href="#_data_path_instructions">Data path (instructions)</a>
<ul class="sectlevel2">
<li><a href="#_register_register_instructions">Register-register instructions</a></li>
<li><a href="#_register_immediate_instructions">Register-immediate instructions</a></li>
<li><a href="#_branch_instructions">Branch instructions</a></li>
<li><a href="#_load_instructions">Load instructions</a></li>
<li><a href="#_store_instructions">Store instructions</a></li>
<li><a href="#_upper_immediate_instructions">Upper immediate instructions</a></li>
<li><a href="#_jump_and_link">Jump and link</a></li>
<li><a href="#_jump_and_link_register">Jump and link register</a></li>
<li><a href="#_control_and_status_register_instructions">Control and status register instructions</a></li>
<li><a href="#_nops">Nops</a></li>
<li><a href="#_environment_calls">Environment calls</a></li>
<li><a href="#_return_from_trap">Return from trap</a></li>
</ul>
</li>
<li><a href="#_data_path_modules">Data path (modules)</a>
<ul class="sectlevel2">
<li><a href="#_raising_an_exception">Raising an exception</a></li>
<li><a href="#_pc_sequential"><code>pc</code> (sequential)</a></li>
<li><a href="#_instruction_fetch_at_pc_combinational">Instruction fetch at <code>pc</code> (combinational)</a></li>
<li><a href="#_data_memory_readwrite_sequential">Data memory read/write (sequential)</a></li>
<li><a href="#_control_and_status_register_bus">Control and Status Register Bus</a></li>
<li><a href="#_exception_encoder">Exception encoder</a></li>
<li><a href="#_main_alu_combinational">Main ALU (combinational)</a></li>
<li><a href="#_register_file_sequential">Register file (sequential)</a></li>
</ul>
</li>
<li><a href="#_data_path_multiplexers">Data path (multiplexers)</a>
<ul class="sectlevel2">
<li><a href="#_main_alu_input_ports">Main ALU input ports</a></li>
<li><a href="#_register_file_write_data">Register file write data</a></li>
<li><a href="#_next_program_counter">Next program counter</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This document describes the design of a single-cycle rv32i_zicsr RISC-V core.</p>
</div>
</div>
</div>
<h1 id="_specification" class="sect0">Specification</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This part summarises the specification for the design, including the ISA that needs supporting, the CSR registers, and the interrupts/exceptions. Throughout the specification, the RISC-V specification is referenced in the following format:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>v1_c9</code> means RISC-V volume 1 (unprivileged ISA), chapter 9</p>
</li>
<li>
<p><code>v1_t9.1</code> means RISC-V volume 1 (unprivileged ISA), table 9.1</p>
</li>
<li>
<p><code>v2_s2.3</code> means RISC-V volume 2 (privileged architecture), section 2.3</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All references to volume 1 refer to version 20191213 (document <code>riscv-spec-20191213.pdf</code>), and references to volume 2 refer to version 20211203 (document <code>riscv-privileged-20211203.pdf</code>). Both documents are available from the <a href="https://riscv.org/technical/specifications/">official specification page</a>.</p>
</div>
<div class="paragraph">
<p>Other non-ISA specifications are also used. References to the Platform-Level Interrupt Controller (PLIC) Specification refer to version 1.0.0, 3/2023 (document <code>riscv-plic-1.0.0.pdf</code>, available <a href="https://wiki.riscv.org/display/HOME/RISC-V+Technical+Specifications">here</a>). References use a format like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>plic_f1</code> means RISC-V PLIC specification, figure 1</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_interrupts">Interrupts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The basic interrupt mechanism follows the Core Local Interruptor (CLINT) specification, based on SiFive chips. The CLINT memory map begins at address <code>0x1000_0000</code>. The meaning of the memory-mapped I/O registers in this region are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>msip</code>: write 1 to this bit to request a software interrupt, and write 0 to clear it. The value of this bit is reflected in the read-only <code>MSIP</code> field of the <code>mip</code> CSR. The register is initialised to zero.</p>
</li>
<li>
<p><code>mtimecmp</code>: this is the 64-bit timer compare register as described in the RISC-V privileged ISA specification. A timer interrupt becomes pending exactly when <code>mtime &gt;= mtimecmp</code>. It is initialised to zero.</p>
</li>
<li>
<p><code>mtime</code>: this is the 64-bit real time register, which increments at a constant rate with wall clock time. It is initialised to zero.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The external interrupt bit <code>meie</code> in <code>mip</code> (the interrupt-pending register) comes directly from an external interrupt controller which follows the PLIC specification (<code>plic_f1</code>). There is only a single hart in this system, which only implements M-mode, therefore there is only one signal line from the PLIC to the hart (the M-mode external interrupt signal; see <code>plic_s1.3</code>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cpu_state">CPU State</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains the parts of the design that hold state, which will correspond to registered parts of the design.</p>
</div>
<div class="paragraph">
<p>The device will need a register file of 32 32-bit registers, where x0 (the first one) is tied to zero (always reads as zero).</p>
</div>
<div class="paragraph">
<p>There is a 32-bit program counter which points to the instruction currently executing.</p>
</div>
<div class="paragraph">
<p>There will be a byte-addressable 32-bit physical address space (for use by the load and store instructions) backed by</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a region of read/write I/O region (containing memory-mapped registers)</p>
</li>
<li>
<p>a region of read/write main memory (RAM)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>(The instruction memory will be separate from the other memory in this design, and will only be accessed by instruction fetch. Since instruction memory will not be writable, it will be implemented as a combinational instance, loaded with initial values at synthesis-time.)</p>
</div>
<div class="paragraph">
<p>The memory map for the physical address space is as follows (all addresses are in hexadecimal):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Memory Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Start Address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Memory-mapped Register</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Physical Memory Attributes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instruction ROM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0000\_0000</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read-only (instruction fetch)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0000\_0000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reset vector (initial PC)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0000\_0004</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NMI vector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0000\_0008</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exception vector (mtvec)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0000\_0014</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Software interrupt vector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0000\_0024</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timer interrupt vector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0000\_0034</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">External interrupt vector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">I/O</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000\_0000</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read/write (load/store)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000\_0000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">msip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000\_4000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mtimecmp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000\_bff8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mtime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Main Memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2000\_0000</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1024</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read/write (load/store)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There are the following minimal set of required control and status registers (CSR). Each is listed in the format "`CSR-address CSR-name`: description".</p>
</div>
<div class="paragraph">
<p>First, there is a set of required informational registers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0xf11 mvendorid</code>: read-only; returns 0 to indicate not implemented.</p>
</li>
<li>
<p><code>0xf12 marchid</code>: read-only; returns 0 to indicate not implemented.</p>
</li>
<li>
<p><code>0xf13 mimpid</code>: read-only; returns 0 to indicate not implemented.</p>
</li>
<li>
<p><code>0xf14 mhartid</code>: read-only; single hart system, returns 0 to indicate hart 0.</p>
</li>
<li>
<p><code>0xf15 mconfigptr</code>: read-only zero, configuration platform-specification defined</p>
</li>
<li>
<p><code>0x301 misa</code>: read/write; single legal value 0 always returned (WARL), meaning architecture is determined by non-standard means (it is rv32im_zicsr implementing M-mode only).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The state of the CPU is stored in the following status registers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x300 mstatus</code>: read/write, containing both WPRI and WARL fields. The bit fields which are non-zero are as follows (assumes only M-mode):</p>
<div class="ulist">
<ul>
<li>
<p>bit 3: MIE (interrupt enable), read/write</p>
</li>
<li>
<p>bit 7: MPIE (previous value of interrupt enable), read/write (?)</p>
</li>
<li>
<p>bits [12:11]: MPP (previous privilege mode), WARL always 0b11 (?)</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>0x310 mstatush</code>: read/write, upper 32-bit of status; all fields are read-only zero (only little-endian memory is supported).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to the global bit in the status register, interrupts are controlled and monitored by these registers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x304 mie</code>: read/write interrupt-enable register. To enable an interrupt in M-mode, both mstatus.MIE and the bit in mie must be set. Bits corresponding to interrupts that cannot occur must be read-only zero.</p>
</li>
<li>
<p><code>0x344 mip</code>: 32-bit read/write interrupt-pending register. Since all fields are read-only, writes to this CSR are no-op. The following bits are defined:</p>
<div class="ulist">
<ul>
<li>
<p>bit 3: machine software interrupt pending (read-only)</p>
</li>
<li>
<p>bit 7: machine timer interrupt pending (read-only)</p>
</li>
<li>
<p>bit 11: machine-level external interrupt pending (read-only)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a trap occurs (either due to an imprecise asynchronous interrupt or a precise synchronous exception), the following registers control where control flow is transferred to and where it returns to after the trap:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x305 mtvec</code>: read-only, trap handler vector table base address</p>
<div class="ulist">
<ul>
<li>
<p>bits [1:0]: 1 (vectored mode)</p>
</li>
<li>
<p>bits [31:2]: trap vector table base address (4-byte aligned)</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>0x341 mepc</code>: 32-bit, read/write register, stores the return-address from trap handler. WARL, valid values are allowed physical addresses (4-byte aligned and fit within physical memory address width).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Information about the trap is obtained from these registers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x342 mcause</code>: 32-bit, read/write, stores exception code and bit indicating whether trap is interrupt. Exception code is WLRL.</p>
</li>
<li>
<p><code>0x343 mtval</code>: read-only zero</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, software may use this register in any way while processing traps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x340 mscratch</code>: 32-bit read/write register for use by trap handlers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following privileged-mode registers hold performance monitoring information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0xb00 mcycle</code>: low 32 bits of read/write 64-bit register incrementing at a constant rate</p>
</li>
<li>
<p><code>0xb80 mcycleh</code>: high 32 bits of read/write, 64-bit register containing number of clock cycles executed by the processor.</p>
</li>
<li>
<p><code>0xb02 minstret</code>: low 32 bits of read/write, 64-bit register containing number of instructions retired by the processor.</p>
</li>
<li>
<p><code>0xb82 minstreth</code>: high 64 bits of read/write, 64-bit register containing number of instructions retired by the processor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These registers are also accessible via the following shadows (intended for use by unprivileged mode; however, there is only M-mode here, so there is no distinction between privilege levels)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0bc00 cycle</code>: read-only shadow of mcycle</p>
</li>
<li>
<p><code>0xc80 cycleh</code>: read-only shadow of mcycleh</p>
</li>
<li>
<p><code>0xc02 instret</code>: read-only shadow of minstret</p>
</li>
<li>
<p><code>0xc82 instreth</code>: read-only shadow of minstreth</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The 64-bit <code>mtime</code> register is memory-mapped (it is not a CSR); however, it does have a read-only shadow as a CSR:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0xc01 time</code>: read-only shadow of lower 32 bits of memory mapped 64-bit mtime</p>
</li>
<li>
<p><code>0xc81 timeh</code>: read-only shadow of upper 32 bits of memory mapped 64-bit mtime</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, the following required performance monitoring counters are all implemented as read-only zero</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>(0xb00 + n) mhpmcountern</code>: read-only zero (<code>n</code> ranges from 3 to 32)</p>
</li>
<li>
<p><code>(0xb80 + n) mhpmcounternh</code>: read-only zero (<code>n</code> ranges from 3 to 32)</p>
</li>
<li>
<p><code>(0x320 + n) mhpmevent</code>: read-only zero (<code>n</code> ranges from 3 to 32)</p>
</li>
<li>
<p><code>(0xc00 + n) hpmcountern</code>:  read-only zero (<code>n</code> ranges from 3 to 32)</p>
</li>
<li>
<p><code>(0xc80 + n) hpmcounternh</code>: read-only zero (<code>n</code> ranges from 3 to 32)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions">Instructions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The required instructions are the 32-bit base integer ISA, the Zicsr extension for CSR manipulation, and the privileged-architecture instruction <code>mret</code>.</p>
</div>
<div class="sect2">
<h3 id="_control_and_status_register_csr_instructions">Control and status register (CSR) instructions</h3>
<div class="paragraph">
<p>The unprivileged specification (<code>v1_ch9</code>) defines the behaviour of the instructions which manipulate CSRs, in the Zicsr ISA extension. The behaviour of the instructions is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>csrrw</code>: read the addressed CSR into destination register <code>rd</code>, and then write the source register <code>rs1</code> to the addressed CSR.</p>
</li>
<li>
<p><code>csrrwi</code>: read the addressed CSR into destination register <code>rd</code>, and then zero extend the immediate <code>uimm</code> and write it to the addressed CSR.</p>
</li>
<li>
<p><code>csrrs</code>: read the addressed CSR into destination register <code>rd</code>. Then, only if the source register <code>rs1</code> is not <code>x0</code>, bitwise-OR the current value of the CSR with <code>rs1</code>, and write the result back to the CSR (i.e. set bits in the CSR where there is a 1 in <code>rs1</code>).</p>
</li>
<li>
<p><code>csrrsi</code>: read the addressed CSR into destination register <code>rd</code>. Then, only if the immediate <code>uimm</code> is not <code>0</code>, bitwise-OR the current value of the CSR with <code>uimm</code> (zero-extended to 32 bits), and write the result back to the CSR (i.e. set bits in the CSR where there is a 1 in <code>uimm</code>).</p>
</li>
<li>
<p><code>csrrc</code>: read the addressed CSR into destination register <code>rd</code>. Then, only if the source register <code>rs1</code> is not <code>x0</code>, bitwise-AND the current value of the CSR with !<code>rs1</code>, and write the result back to the CSR (i.e. clear bits in the CSR where there is a 1 in <code>rs1</code>).</p>
</li>
<li>
<p><code>csrrci</code>: read the addressed CSR into destination register <code>rd</code>. Then, only if the immediate <code>uimm</code> is not <code>0</code>, bitwise-AND the current value of the CSR with <code>!uimm</code> (zero-extended to 32 bits <em>after</em> negation), and write the result back to the CSR (i.e. clear bits in the CSR where there is a 1 in <code>uimm</code>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any instructions that write to a CSR:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>will raise an illegal instruction exception if the CSR is read-only. In this case, the state of registers will be as if the instruction did not occur.</p>
</li>
<li>
<p>will not change the value of an CSR bits that are read-only in otherwise writable registers</p>
</li>
<li>
<p>for WLRL fields in writable CSRs, any value that is written (even an invalid one) will be written anyway, without any checking in hardware.</p>
</li>
<li>
<p>for WARL fields in writable CSRs, any attempt to write an invalid value will cause no change in the CSR field (the old value will be retained).</p>
</li>
<li>
<p>the write will displace any other automatic modification of the CSR by hardware; for example, writing to <code>instret</code> will stop auto-increment of <code>instret</code> on that instruction (<code>v1_s9.1</code>). This is also interpreted as applying to all counters, including <code>mcycle</code>, etc.)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Instructions that read CSRs read the value of the CSR as it was just prior to instruction execution (e.g. the value of <code>instret</code> is taken before incrementing in due to the read instruction itself).</p>
</div>
<div class="paragraph">
<p>Instructions that attempt to perform an operation on a non-existent CSR raise an illegal instruction exception.</p>
</div>
<div class="sect3">
<h4 id="_notes_on_behaviour">Notes on behaviour</h4>
<div class="ulist">
<ul>
<li>
<p>The instructions are defined (<code>v1_s9.1</code>) to atomically read and write CSRs. Since there is only one hart in this design, this required is satisfied by a single read/write operation.</p>
</li>
<li>
<p>The <code>csrrw</code> and <code>csrrwi</code> instructions are defined (<code>v1_t9.1</code>) to omit the CSR read if the destination register <code>rd</code> is <code>x0</code>, and not trigger any side effects that would occur on a read. In this design, no CSR has a side effect that occurs on a read, so for simplicity the <code><strong>rw</strong></code> instructions can perform a read irrespective of <code>rd</code>, and attempt the write to <code>rd</code> (which will have no effect if <code>rd</code> is <code>x0</code>).</p>
</li>
<li>
<p>In this design, all CSRs are 32-bits wide, so there is no need to zero-extend them before writing to registers.</p>
</li>
<li>
<p>In this design, writing invalid values to WLRL fields does not raise an illegal instruction exception (<code>v2_s2.3</code>).</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exceptions">Exceptions</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_interrupts_2">Interrupts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This design implements the CLINT interrupt specification</p>
</div>
</div>
</div>
<h1 id="_design" class="sect0">Design</h1>
<div class="openblock partintro">
<div class="content">
This file contains the design of the core, including the data path and control. Each part will be broken down into what modules and instances are needed, and how the instructions utilise each part of the design.
</div>
</div>
<div class="sect1">
<h2 id="_data_path_instructions">Data path (instructions)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how the instruction uses the hardware of the data path.</p>
</div>
<div class="sect2">
<h3 id="_register_register_instructions">Register-register instructions</h3>
<div class="paragraph">
<p>The following instructions operate on two register operands and write their result into the register file: <code>add</code>, <code>sub</code>, <code>sll</code>, <code>slt</code>, <code>sltu</code>, <code>xor</code>, <code>srl</code>, <code>sra</code>, <code>or</code>, <code>and</code>. Supporting these instructions requires:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a register file that supports two port reads (combinationally depending on the <code>rs1</code> and <code>rs2</code> fields in the R-type instruction format); and supports a single-port registered write port, with the write register index selected from the <code>rd</code> field in the R-type instruction.</p>
</li>
<li>
<p>an ALU with two input ports for 32-bit operands; that supports the arithmetic and logical operations above; has inputs routable from the register file read data output ports; and has an output routable to the register file write data input port.</p>
</li>
<li>
<p>the next <code>pc</code> is <code>pc+4</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_register_immediate_instructions">Register-immediate instructions</h3>
<div class="paragraph">
<p>The following instructions operate on a register operand and an immediate encoded in the instructions: <code>addi</code>, <code>slti</code>, <code>sltiu</code>, <code>xori</code>, <code>ori</code>, <code>andi</code>, <code>slli</code>, <code>srli</code>, <code>srai</code>. Supporting these instructions requires:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a way to route the <code>imm[11:0]</code> field of the I-type instruction to the second input operand of the ALU (the first input operand comes from the <code>rs1</code> output of the register file)</p>
</li>
<li>
<p>in the case of <code>slli</code>, <code>srli</code>, and <code>srai</code>, the <code>imm[11:0]</code> fields must be masked to the lower 5 bits, and bit 30 of the instruction should be used to control the type of right shift operation in the ALU (1 for arithmetic shift, 0 for logical).</p>
</li>
<li>
<p>routing the output of the ALU to the write port of the register file, with register index from the <code>rd</code> field of the I-type instruction.</p>
</li>
<li>
<p>the next <code>pc</code> is <code>pc+4</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_branch_instructions">Branch instructions</h3>
<div class="paragraph">
<p>The following instructions operate on two register operands, and take a pc-relative branch if a condition is satisfied: <code>beq</code>, <code>bne</code>, <code>blt</code>, <code>bge</code>, <code>bltu</code>, <code>bgeu</code>. Supporting these instructions requires:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>routing the two register operands to the ALU, the same as the register-register instructions</p>
</li>
<li>
<p>setting the operation of the ALU depending on the instruction:</p>
<div class="ulist">
<ul>
<li>
<p><code>beq</code>: subtract</p>
</li>
<li>
<p><code>bne</code>: subtract</p>
</li>
<li>
<p><code>blt</code>: use <code>slt</code></p>
</li>
<li>
<p><code>bge</code>: use <code>slt</code></p>
</li>
<li>
<p><code>bltu</code>: use <code>sltu</code></p>
</li>
<li>
<p><code>bgeu</code>: use <code>sltu</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>creating a <code>branch_taken</code> signal from the output of the ALU depending on the instruction:</p>
<div class="ulist">
<ul>
<li>
<p><code>beq</code>: <code>zero</code></p>
</li>
<li>
<p><code>bne</code>: <code>!zero</code></p>
</li>
<li>
<p><code>blt</code>: <code>alu_result[0]</code></p>
</li>
<li>
<p><code>bge</code>: <code>!alu_result[0]</code></p>
</li>
<li>
<p><code>bltu</code>: <code>alu_result[0]</code></p>
</li>
<li>
<p><code>bgeu</code>: <code>!alu_result[0]</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>form the immediate <code>offset</code> from the <code>imm</code> fields in the B-type instruction.</p>
</li>
<li>
<p>if <code>branch_taken</code> signal is set and <code>pc + offset</code> is not four-byte aligned, raise <code>InstructionAddressMisaligned</code> exception; otherwise, next <code>pc</code> is <code>pc + offset</code>.</p>
</li>
<li>
<p>if <code>!branch_taken</code>, next <code>pc</code> is <code>pc + 4</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note: does this instruction require two ALUs? One for the branch condition comparison and one for <code>pc + offset</code>? Or can we maybe use the same ALU being used for <code>pc + 4</code> to compute <code>pc + offset</code>?</p>
</div>
</div>
<div class="sect2">
<h3 id="_load_instructions">Load instructions</h3>
<div class="paragraph">
<p>The following instructions read a value from memory and write it to a destination registers: <code>lb</code>, <code>lh</code>, <code>lw</code>, <code>lbu</code>, <code>lhu</code>. Supporting these instructions requires:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>routing the <code>base</code> (<code>rs1</code>) register index from the I-type instruction to the register file</p>
</li>
<li>
<p>routing the output of the register file to the first input of the ALU</p>
</li>
<li>
<p>routing the <code>offset</code> stored in the instruction to the other input of the ALU</p>
</li>
<li>
<p>setting the ALU operation to addition</p>
</li>
<li>
<p>routing the output of the ALU to the physical memory attributes checker</p>
</li>
<li>
<p>if the memory read will be invalid, raise <code>LoadAccessFault</code> exception and prevent memory read/register write.</p>
</li>
<li>
<p>if read is OK, configure the memory to read a byte, halfword, or word, based on the instruction</p>
</li>
<li>
<p>routing the output from the data memory through a zero-extension or sign-extension based on the instruction</p>
</li>
<li>
<p>routing that result to the register file write port (write register comes from <code>rd</code> value in instruction).</p>
</li>
<li>
<p>set next <code>pc</code> to <code>pc + 4</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_store_instructions">Store instructions</h3>
<div class="paragraph">
<p>The following instructions write a value from a register to a memory address: <code>sb</code>, <code>sh</code>, <code>sw</code>. Supporting these instructions requires:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>routing the <code>base</code> (<code>rs1</code>) register index from the S-type instruction to the first read port of the register file</p>
</li>
<li>
<p>routing the first output of the register file to the first input of the ALU</p>
</li>
<li>
<p>obtaining the <code>offset</code> from the <code>imm</code> fields of the S-type instruction and placing the result on the second ALU</p>
</li>
<li>
<p>setting the ALU operation to addition</p>
</li>
<li>
<p>routing the <code>src</code> register index from the S-type instruction to the second read port of the register file</p>
</li>
<li>
<p>routing the second output port of the register file to the write input of the data memory.</p>
</li>
<li>
<p>routing the output of the ALU to the physical memory attributes checker</p>
</li>
<li>
<p>if the memory read will be invalid, raise <code>StoreAccessFault</code> exception and prevent memory write.</p>
</li>
<li>
<p>if write is OK, configure memory to write a byte, halfword, or word, based on the instruction</p>
</li>
<li>
<p>set next <code>pc</code> to <code>pc + 4</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_upper_immediate_instructions">Upper immediate instructions</h3>
<div class="paragraph">
<p>These instruction construct upper immediates: <code>lui</code> and <code>auipc</code>; they are implemented by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>routing the <code>dest</code> field of the U-type instruction to the write port address of the register file.</p>
</li>
<li>
<p>combine the <code>imm</code> field of the U-type instruction with 12 low zeros; route it to port 2 of the ALU</p>
</li>
<li>
<p>set the ALU operation to addition</p>
</li>
<li>
<p>if the instruction is <code>auipc</code>, route the current <code>pc</code> to port 1 of the ALU; else 0 for <code>lui</code>.</p>
</li>
<li>
<p>route the output of the ALU to the write data port of the register file</p>
</li>
<li>
<p>set next <code>pc</code> to <code>pc + 4</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_jump_and_link">Jump and link</h3>
<div class="paragraph">
<p>The <code>jal</code> instruction is implemented by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>routing the <code>imm</code> fields of the J-type instruction through a sign-extending module</p>
</li>
<li>
<p>routing the sign extended result to the second port of the ALU</p>
</li>
<li>
<p>routing the current <code>pc</code> to the first port of the ALU</p>
</li>
<li>
<p>setting the ALU operation to addition</p>
</li>
<li>
<p>checking the result from the ALU is four-byte aligned. If not, raise <code>InstructionAddressMisaligned</code> exception and do not perform the register writes below.</p>
</li>
<li>
<p>setting the next <code>pc</code> to the output from the ALU.</p>
</li>
<li>
<p>route the <code>dest</code> field of the J-type instruction to the write address port of the register file</p>
</li>
<li>
<p>setting the write data port of the register file to <code>pc + 4</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_jump_and_link_register">Jump and link register</h3>
<div class="paragraph">
<p>The <code>jalr</code> instruction is implemented by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>routing the <code>imm</code> fields of the I-type instruction to a sign extension module</p>
</li>
<li>
<p>routing the result of the sign extension to the second port of the ALU</p>
</li>
<li>
<p>routing the <code>base</code> field of the I-type instruction to the first read port of the register file</p>
</li>
<li>
<p>routing the first output port of the register file to the first port of the ALU</p>
</li>
<li>
<p>setting the ALU operation to addition</p>
</li>
<li>
<p>routing the output of the ALU through a mask to set the low bit to zero</p>
</li>
<li>
<p>checking the result is four-byte aligned. If not, raise <code>InstructionAddressMisaligned</code> exception and do not perform the register writes below.</p>
</li>
<li>
<p>routing the result to the next <code>pc</code>.</p>
</li>
<li>
<p>route the <code>dest</code> field of the J-type instruction to the write address port of the register file</p>
</li>
<li>
<p>setting the write data port of the register file to <code>pc + 4</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_control_and_status_register_instructions">Control and status register instructions</h3>
<div class="paragraph">
<p>The instructions <code>csrrw</code>, <code>csrrs</code>, <code>csrrc</code>, <code>csrrwi</code>, <code>csrrsi</code>, and <code>csrrci</code> read and write CSRs. The <code><strong>rw</strong></code> instructions always write irrespective of arguments, and the <code><strong>rs</strong>/<strong>rc</strong></code> instructions always read irrespective of arguments. These instructions are implemented by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>routing the CSR address to the CSR address bus (which specifies a CSR to both read and write)</p>
</li>
<li>
<p>if the CSR does not exist, raise an illegal instruction exception and do not perform the operations below.</p>
</li>
<li>
<p>routing the destination register index <code>rd</code> of the instruction to the write data address port of the register file.</p>
</li>
<li>
<p>routing the data output of the CSR to the write data input port of the register file.</p>
</li>
<li>
<p>routing the data output of the CSR to the first port of the ALU</p>
</li>
<li>
<p>configure the ALU operation to be OR (<code>csrrs(i)</code>) or AND (<code>csrrc(i)</code>) depending on the instruction</p>
</li>
<li>
<p>route the <code>rs1</code> field to the first read port of the register file (this can be done even for immediate instructions; the output of the register file is unused)</p>
</li>
<li>
<p>select the second port of the ALU from:</p>
<div class="ulist">
<ul>
<li>
<p>the output of the first read port on the register file (<code>csrrs</code>)</p>
</li>
<li>
<p>the negated output of the first read port on the register file (<code>csrrc</code>)</p>
</li>
<li>
<p>the <code>uimm</code> instruction field (zero-extended) (<code>csrrsi</code>)</p>
</li>
<li>
<p>the <code>!uimm</code> field (zero-extended) (<code>csrrci</code>)</p>
</li>
</ul>
</div>
</li>
<li>
<p>select the CSR write data line from</p>
<div class="ulist">
<ul>
<li>
<p>the first read output from the register file (<code>csrrw</code>)</p>
</li>
<li>
<p>the <code>uimm</code> field from the instruction (<code>csrrwi</code>)</p>
</li>
<li>
<p>the output of the ALU (the rest of the instructions)</p>
</li>
</ul>
</div>
</li>
<li>
<p>set the CSR bus write enable signal depending on the instruction and whether <code>rs1</code> is zero, or <code>uimm</code> is zero.</p>
</li>
<li>
<p>if the attempted write to the CSR is read-only, raise an illegal instruction exception, and prevent the CSR data being written to <code>rd</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the CSR bus, if a write is performed, ensure this prevents any automatic updating action the CSR may take when it is not written. Each CSR module on the CSR bus is responsible for only updating its writable fields (and masking out attempted changes to non-writable fields, or WARL fields where the written value is not legal).</p>
</div>
</div>
<div class="sect2">
<h3 id="_nops">Nops</h3>
<div class="paragraph">
<p>The instructions <code>fence</code> and <code>wfi</code> are implemented as <code>nop</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>set the next <code>pc</code> to <code>pc + 4</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_environment_calls">Environment calls</h3>
<div class="paragraph">
<p>The instructions <code>ecall</code> and <code>ebreak</code> raise the exceptions <code>MmodeEcall</code> and <code>Breakpoint</code> respectively, and take no further action.</p>
</div>
</div>
<div class="sect2">
<h3 id="_return_from_trap">Return from trap</h3>
<div class="paragraph">
<p>The <code>mret</code> instruction is implemented by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>restoring the <code>MPIE</code> bit to the <code>MIE</code> bit in the <code>mstatus</code> CSR</p>
</li>
<li>
<p>setting the <code>MPIE</code> bit to 1 in the <code>mstatus</code> CSR</p>
</li>
<li>
<p>setting the next <code>pc</code> to <code>mepc</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_path_modules">Data path (modules)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This presents a draft of the different components of the data path, focusing on what they will do while different instructions are executing.</p>
</div>
<div class="sect2">
<h3 id="_raising_an_exception">Raising an exception</h3>
<div class="paragraph">
<p>The exception mechanism is partly implemented in the data path and partly in the control unit. The policy for raising an exception in this single-cycle design is that no combinational calculation which caused the exception to be raised can be modified by the exception (otherwise there would be a circular dependency in the calculation). As a result, extra logic may need to be implemented that disables any actions that would be taken where there is no exception, in cases where disabling an action would also de-assert the exception itself.</p>
</div>
<div class="paragraph">
<p>Due to the results of calculations performed in the combinational work of an instruction, the data path may need to raise an exception. When this happens, the instruction should be prevented from registering the results of the instruction that would occur if no exception occurred, by having the control unit disable these writes. In addition, the following actions take place when an exception is raised:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>mepc</code> CSR is set to <code>pc</code></p>
</li>
<li>
<p>the <code>mcause</code> register is set to be written with the exception cause</p>
</li>
<li>
<p>the <code>MIE</code> bit is saved to <code>MPIE</code> in the <code>mstatus</code> CSR, and the <code>MIE</code> bit itself is cleared.</p>
</li>
<li>
<p>the next <code>pc</code> is set to the exception <code>BASE</code> address stored in <code>mtvec</code> (this can be hardwired in this design)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that many of these steps also happen for an <code>interrupt</code> (they are generic trap steps). However, an interrupt sets a different <code>mepc</code> value and <code>mcause</code>, and jumps to a vectored interrupt).</p>
</div>
</div>
<div class="sect2">
<h3 id="_pc_sequential"><code>pc</code> (sequential)</h3>
<div class="paragraph">
<p>The current <code>pc</code> is a single 32-bit register, which is loaded on the rising edge of the clock from the output of <code>next_pc</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-kt">reg</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">pc</span><span class="tok-p">;</span>
<span class="tok-kt">wire</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">next_pc</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-c1">// output from next_pc instance</span>

<span class="tok-k">always</span><span class="tok-w"> </span><span class="tok-p">@(</span><span class="tok-k">posedge</span><span class="tok-w"> </span><span class="tok-n">clk</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">begin</span>
<span class="tok-w">	</span><span class="tok-n">pc</span><span class="tok-w"> </span><span class="tok-o">&lt;=</span><span class="tok-w"> </span><span class="tok-n">next_pc</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>No check is performed for address alignment, because that is checked in <code>next_pc</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_instruction_fetch_at_pc_combinational">Instruction fetch at <code>pc</code> (combinational)</h3>
<div class="paragraph">
<p>The instruction memory is an instance of a <code>instr_mem</code> module, which has the following signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-c1">/// Fetch an instruction from program memory</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// The instruction memory is preloaded with instructions at</span>
<span class="tok-c1">/// synthesis time in this design. It is combinational, so the</span>
<span class="tok-c1">/// output changes directly with the input pc. No checking is</span>
<span class="tok-c1">/// performed for pc 4-byte alignment (the lower 2 bits of pc</span>
<span class="tok-c1">/// are just ignored).</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// An InstructionAccessFault exception is raised if the pc is</span>
<span class="tok-c1">/// out of range for the valid program memory addresses. In</span>
<span class="tok-c1">/// this design, the program memory is 1024 bytes, so that</span>
<span class="tok-c1">/// occurs if pc &gt; 1020. If the exception is raised, the instr</span>
<span class="tok-c1">/// output has an unspecified value.</span>
<span class="tok-c1">///</span>
<span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">instr_mem</span><span class="tok-p">(</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">pc</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-c1">// current pc</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">instr</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-c1">// the instruction at pc</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">instr_access_fault</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// flag for instruction access fault exception</span>
<span class="tok-w">	</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_memory_readwrite_sequential">Data memory read/write (sequential)</h3>
<div class="paragraph">
<p>The data memory is a byte-addressable which holds both main memory and memory-mapped I/O regions. It is sequential because write data is stored into the memory on the rising edge of the clock (read data is combinational). There is one write port and one read port. The only instructions which interact with the data memory are load and store instructions.</p>
</div>
<div class="paragraph">
<p>The signature of the <code>data_mem</code> module is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-c1">/// Data memory module with one write and one read port</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// To read, set the read_addr and read data from the</span>
<span class="tok-c1">/// read_data output (valid if no load exception occurred).</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// To write, set the write_addr and write_data, and set</span>
<span class="tok-c1">/// the write_en. Data will be written on the rising clock</span>
<span class="tok-c1">/// edge.</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// For both reads and writes, the width is specified using</span>
<span class="tok-c1">/// the write_width or read_width input, which has the following</span>
<span class="tok-c1">/// encoding (binary):</span>
<span class="tok-c1">///</span>
<span class="tok-c1">///  00: read/write a byte (8 bits)</span>
<span class="tok-c1">///  01: read/write a half word (16 bits)</span>
<span class="tok-c1">///  10: read/write a word (32 bits)</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// On a non-word read, the high bits of the output contain</span>
<span class="tok-c1">/// zeros. On a non-word write, the high bits of the input are</span>
<span class="tok-c1">/// ignored.</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// Both reads and writes of main memory and I/O memory</span>
<span class="tok-c1">/// can use any alignment and width, so {load,store} address</span>
<span class="tok-c1">/// misaligned exceptions do not occur in this design.</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// Access fault exceptions occur based on the read or write</span>
<span class="tok-c1">/// address. On a load access fault, the read_data is unspecified.</span>
<span class="tok-c1">/// On a store access fault, no data is written, even if write_en</span>
<span class="tok-c1">/// is set. The flags for access faults are both combinational;</span>
<span class="tok-c1">/// they are set immediately based on the address (a store access</span>
<span class="tok-c1">/// fault does not wait until the rising clock edge).</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// The memory map for this data memory is as follows (hexadecimal</span>
<span class="tok-c1">/// ranges a - b mean the region starts at a, and the first byte outside</span>
<span class="tok-c1">/// the region is b):</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// I/O region:</span>
<span class="tok-c1">///    1000_0000 - 1000_0004 (msip)</span>
<span class="tok-c1">///    1000_4000 - 1000_4008 (mtimecmp)</span>
<span class="tok-c1">///    1000_bff8 - 1000_c000 (mtime)</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// Main memory:</span>
<span class="tok-c1">///    2000_0000 - 2000_0400</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// Only read/writes to the regions above are allowed. Any read or</span>
<span class="tok-c1">/// write that falls partially or completely outside the ranges</span>
<span class="tok-c1">/// will generate an access fault.</span>
<span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">data_mem</span><span class="tok-p">(</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">clk</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// clock (write on rising edge)</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">write_addr</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// write port address</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">1</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">write_width</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// write width</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">write_data</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// write port data</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">write_en</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 1 to write on rising clock edge, else 0 for no write</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">read_addr</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// read port address</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">1</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">read_width</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// read width</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">read_data</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// read port data output</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">load_access_fault</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// set on LoadAccessFault exception</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">store_access_fault</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// set on StoreAccessFault exception</span>
<span class="tok-w">	</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_notes">Notes</h4>
<div class="paragraph">
<p>Maybe this is more like a physical memory attributes checker module, not the actual data memory. Ideally, the I/O region (with the memory-mapped CSRs and in the future, other peripherals) should be independent of the data memory. Probably a bus architecture of some kind is more appropriate, where the bus itself is the physical address space, but devices attached to the bus can opt to service the request if the address is within their memory range. There could be a data bus that contains the output, driven by whichever module is servicing the request. The physical memory attributes checker could also be attached to this bus.</p>
</div>
<div class="paragraph">
<p>Possible there is no need for a PMA checker at all&#8201;&#8212;&#8201;if each peripheral connected to the bus "claims" the read or write by asserting a signal, then the PMA check could be as simple as checking that at least one device as claimed the read/write (a peripheral would only claim it if the entirety of the read/write falls within it&#8217;s valid address range).</p>
</div>
<div class="paragraph">
<p>Any device on the data memory physical address bus could have the following signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-c1">/// Example device connected to data memory bus</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// For this bus, only a single read or write is allowed at once. This</span>
<span class="tok-c1">/// is fine, because only a load or store instruction is being executed</span>
<span class="tok-c1">/// at once, and these are the only ways the CPU can access the data memory</span>
<span class="tok-c1">/// (note that &quot;back-channel&quot; accesses, like updating memory mapped registers</span>
<span class="tok-c1">/// like mtime internall, do not use the data memory bus for the access).</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// A device like this &quot;claims&quot; a read/write by asserting the &quot;claim&quot; signal,</span>
<span class="tok-c1">/// depending on whether it &quot;owns&quot; the address range (determined from the</span>
<span class="tok-c1">/// addr and width). By design, only a single device on the bus can claim</span>
<span class="tok-c1">/// a read/write. Externally, all the claim signals are ORed together, and if</span>
<span class="tok-c1">/// no device claims the read/write, an access fault occurs. (The write_en</span>
<span class="tok-c1">/// signal is also shared between all devices, and this can be used in</span>
<span class="tok-c1">/// combination with the ORed claim signals to distinguish a load/store</span>
<span class="tok-c1">/// access fault.)</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// If a write is claimed, the write is performed on the rising edge of the</span>
<span class="tok-c1">/// clock. If a read is claimed, then the data_out line is set to the</span>
<span class="tok-c1">/// result of the read. If the read is not claimed, the data_out line is</span>
<span class="tok-c1">/// guaranteed to be zero. This means these lines can be ORed externally</span>
<span class="tok-c1">/// to form the data_out bus.</span>
<span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">example_device</span><span class="tok-p">(</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">clk</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// if the device can be written to, it needs a clock</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">addr</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// the read/write address bus</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">1</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">width</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">/// the width of the read/write</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">data_in</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// data to be written on rising clock edge</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">write_en</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 1 to perform write, 0 otherwise</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">data_out</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// data out</span>

<span class="tok-w">	</span><span class="tok-c1">// other signals specific to the device</span>
<span class="tok-w">	</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Devices that are needed on the bus include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>main_memory</code>: fixed block of contiguous memory; claims reads/writes contained in the range <code>0x2000_0000 - 0x2000_0400</code>.</p>
</li>
<li>
<p><code>msip</code>: memory-mapped register, claims reads/writes in the range `0x1000_0000 - 0x1000_0004 `. Only the lowest bit is writable. Attempts to write other bits are ignored, and other bits always read as zero.</p>
</li>
<li>
<p><code>mtimecmp</code>: memory-mapped register, claims reads/writes in the range <code>0x1000_4000 - 0x1000_4008</code>.</p>
</li>
<li>
<p><code>mtime</code>: memory-mapped register, claims reads/writes in the range <code>0x1000_bff8 - 0x1000_c000</code>. Automatically increment on each clock cycle.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_control_and_status_register_bus">Control and Status Register Bus</h3>
<div class="paragraph">
<p>The CSR registers are attached to an address space which is different from the data memory physical address space, but which can be implemented in the same way. Each CSR is represented as a device attached to the bus (similar CSRs can be grouped into a single module), with the following signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">csr_module</span><span class="tok-p">(</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">clk</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// clock for writing on the rising edge</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">11</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">addr</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// CSR address. Used to claim a CSR read/write.</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">write_data</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// data to write to the CSR</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">write_en</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 1 to write on rising clock edge</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">read_data</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">//</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">claim</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 1 if this module owns the CSR addr</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">illegal_instr</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 1 if illegal instruction should be raised</span>

<span class="tok-w">	</span><span class="tok-c1">// Other arguments not related to CSR bus (e.g. memory mapping,</span>
<span class="tok-w">	</span><span class="tok-c1">// hardware access, etc.)</span>
<span class="tok-w">	</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Modules will be designed so that a given register is controlled by only a single module. These are the kinds of modules that will be present:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>read-only zero CSR modules: these only need a single CSR-bus port which always returns zero on reads or illegal instruction on writes. Examples include <code>mvendorid</code>, <code>marchid</code>, <code>mimpid</code>, <code>mhartid</code>, <code>mconfigptr</code>, <code>misa</code>, <code>mhpmcountern</code>, <code>mhpmcounternh</code>, <code>mhpmevent</code>, <code>hpmcountern</code>, <code>hpmcounternh</code>, <code>mtval</code> (these can all be collected into a single module)</p>
</li>
<li>
<p>read/write CSRs which are not used by hardware: these require a read/write CSR-bus interface only. Examples are <code>mscratch</code>.</p>
</li>
<li>
<p>read/write CSRs which can only be read by hardware: these need a read/write CSR-bus port, and access for hardware to read the bits. Examples include <code>mie</code>.</p>
</li>
<li>
<p>read-only non-zero CSR modules: these return a non-zero value, but cause illegal instruction on writes. Examples include <code>mtvec</code>,</p>
</li>
<li>
<p>read/write CSRs which can also be written by hardware: these need a CSR-bus port for read/write, and also a direct-hardware port for the CPU to read/update the bits in the CSRs. Examples include <code>mstatus</code> and <code>mstatush</code> (note that this is a read/write register, even though all fields are read-only zero), <code>mcycle</code>, <code>mcycleh</code>, <code>minstret</code>, <code>minstreth</code>, <code>mcause</code>, <code>mepc</code>. These modules should also provide access to read-only shadows of these registers (like <code>cycle</code>, <code>cycleh</code>, <code>instret</code>, <code>instreth</code>).</p>
</li>
<li>
<p>read-only memory-mapped CSRs updated by hardware: these require a CSR-bus supporting reads (writes return illegal instruction), and also a data memory bus for access via the physical address space. In addition, hardware requires a read/write port for reading and updating the values. Examples include <code>time</code> and <code>timeh</code> (i.e. 64-bit <code>mtime</code>)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_trap_module_sequential">Trap module (sequential)</h4>
<div class="paragraph">
<p>This module is responsible for controlling interrupts and exceptions. It also holds the registers related to interrupts and exceptions, some of which are memory-mapped and some are exposed as CSRs. The signature of the module is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-c1">/// Trap control (interrupts and exceptions)</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// This module holds the following status of the core:</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// mie: global interrupt enable bit in mstatus</span>
<span class="tok-c1">/// mpie: previous mie in mstatus</span>
<span class="tok-c1">/// msie, mtie, meie: software, timer and external</span>
<span class="tok-c1">/// interrupt enable bits in mie</span>
<span class="tok-c1">/// msip, mtip, meip: software, timer and external</span>
<span class="tok-c1">/// interrupt pending bits in mip</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// It holds the following memory-mapped registers</span>
<span class="tok-c1">/// related to interrupt control:</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// mtime: 64-bit real-time register</span>
<span class="tok-c1">/// mtimecmp: defines the trigger for a timer</span>
<span class="tok-c1">/// interrupt in relation to mtime</span>
<span class="tok-c1">/// msip: register containing the software read/writable</span>
<span class="tok-c1">/// msip bit</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// It manages/exposes the following control and status</span>
<span class="tok-c1">/// registers:</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// mstatus: contains the mie, mpie and mpp bits</span>
<span class="tok-c1">/// mepc: return address after trap</span>
<span class="tok-c1">/// mcause: the cause of the trap</span>
<span class="tok-c1">/// mtvec: defines the location and type of trap</span>
<span class="tok-c1">/// handler vectors (this is hardcoded in this design)</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// In normal instruction execution, mtime is incremented</span>
<span class="tok-c1">/// on the rising clock edge.</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// On Interrupts</span>
<span class="tok-c1">/// ~~~~~~~~~~~~~</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// Interrupts are checked at the beginning of each</span>
<span class="tok-c1">/// execution cycle, &quot;logically&quot; before instruction</span>
<span class="tok-c1">/// execution begins (therefore interrupts take priority</span>
<span class="tok-c1">/// over exceptions). An interrupt trap occurs if:</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// 1) interrupts are globally enabled (mie set in mstatus)</span>
<span class="tok-c1">/// AND</span>
<span class="tok-c1">/// 2) external interrupt is enabled and pending (meie and meip)</span>
<span class="tok-c1">/// OR software interrupt is enabled and pending (msie and msip)</span>
<span class="tok-c1">/// OR timer interrupt is enabled and pending (mtie and mtip)</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// Interrupts in 2) are checked in the order given, and the</span>
<span class="tok-c1">/// first enabled and pending interrupt is the one that traps.</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// On an interrupt trap, the mepc is set to current pc + 4.</span>
<span class="tok-c1">/// The mcause register is set to (0x8000_0000 | code), where</span>
<span class="tok-c1">/// code is 3 for software interrupt, 7 for timer interrupt,</span>
<span class="tok-c1">/// or 11 for external interrupt. The interrupt_offset is set</span>
<span class="tok-c1">/// to (code &lt;&lt; 2).</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// On Exceptions</span>
<span class="tok-c1">/// ~~~~~~~~~~~~~</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// An exception is raised &quot;mid&quot; instruction (in the single-cycle</span>
<span class="tok-c1">/// design, this means some combinational element will raise an</span>
<span class="tok-c1">/// exception bit for the currently fetched instruction and core</span>
<span class="tok-c1">/// state). All these bits are fed into an exception encoder,</span>
<span class="tok-c1">/// which produces an exception bit and the mcause values.</span>
<span class="tok-c1">/// These are used as input to this module.</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// As a result, an exception trap will occur. The mepc is set</span>
<span class="tok-c1">/// to the current pc. The mcause register is set to the value</span>
<span class="tok-c1">/// of the mcause input. The interrupt_offset is set to 0.</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// On Any Trap</span>
<span class="tok-c1">/// ~~~~~~~~~~~~</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// On any trap (interrupts or exceptions), the mie bit is</span>
<span class="tok-c1">/// copied to mpie in mstatus, and the mie bit is set to zero.</span>
<span class="tok-c1">/// The exception_vector is set to the base address stored in</span>
<span class="tok-c1">/// mtvec (this is hard-coded in this design).</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// Any other instruction that may have executed on this clock</span>
<span class="tok-c1">/// cycle must be disabled. This is achieved by disabling any</span>
<span class="tok-c1">/// action that would change the core&#39;s state. This is the write</span>
<span class="tok-c1">/// enable for the register file, the memory, and the CSR bus.</span>
<span class="tok-c1">/// The design can use the trap ouptut to determine whether to</span>
<span class="tok-c1">/// do this.</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// On Return From Trap</span>
<span class="tok-c1">/// ~~~~~~~~~~~~~~~~~~~</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// If a return from trap is requested by setting the mret</span>
<span class="tok-c1">/// input, then the mstatus mpie bit is copied to mie, and</span>
<span class="tok-c1">/// the mpie bit is set to 1. (The mepc output is to be used by</span>
<span class="tok-c1">/// the next_pc_sel multiplexer to set the return address.)</span>
<span class="tok-c1">///</span>
<span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">trap_ctrl</span><span class="tok-p">(</span>
<span class="tok-w">	</span><span class="tok-n">clk</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// clock for updating registers</span>

<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">meie</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// external interrupt source (from PLIC)</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">mret</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// set to perform a return from trap</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">exception</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// has an exception been raised</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">mcause</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// the cause of the exception</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">pc</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// used for setting mepc on exception</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">pc_plus_4</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// used for setting mepc on interrupt</span>

<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">trap</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// set if any trap is detected</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">interrupt</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// set if an interrupt is detected</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">mepc</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// exception pc for use by next_pc_sel</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">exception_vector</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// for use by next_pc_set</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">interrupt_offset</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// for use by next_pc_set</span>

<span class="tok-w">	</span><span class="tok-c1">// Data memory read/write port</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">addr</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// the read/write address bus</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">1</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">width</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">/// the width of the read/write</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">data_in</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// data to be written on rising clock edge</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">data_write_en</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 1 to perform write, 0 otherwise</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">data_out</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// data out</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">data_mem_claim</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// set if this module claims the data memory access</span>

<span class="tok-w">	</span><span class="tok-c1">// CSR bus read/write port</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">11</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">addr</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// CSR address. Used to claim a CSR read/write.</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">csr_in</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// data to write to the CSR</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">csr_write_en</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 1 to write on rising clock edge</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">csr_out</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">//</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">csr_bus_claim</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 1 if this module owns the CSR addr</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">illegal_instr</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 1 if illegal instruction should be raised</span>
<span class="tok-w">	</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exception_encoder">Exception encoder</h3>
<div class="paragraph">
<p>This module is a combinational unit that takes all the possible exception flags (from the various other modules of the data path) and convert them into an exception bit and exception cause value for use as input into the trap module. The signature is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-c1">/// Converts exception bits into mcause values</span>
<span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">exception_encoder</span><span class="tok-p">(</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">instr_addr_mis</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// instruction address misaligned, mcause 0</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">instr_access_fault</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// instruction access fault, mcause 1</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">illegal_instr</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// illegal instruction, mcause 2</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">breakpoint</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// breakpoint (from ebreak), mcause 3</span>
<span class="tok-w">	</span><span class="tok-c1">// load address misaligned unused in this design</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">load_access_fault</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// load access fault, mcause 5</span>
<span class="tok-w">	</span><span class="tok-c1">// store address misaligned unused in this design</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">store_access_fault</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// store access fault, mcause 7</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">ecall_mmode</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// ecall from M-mode, mcause 11</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">exception</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// set on any exception</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">mcause</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// what exception was raised</span>
<span class="tok-w">	</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_main_alu_combinational">Main ALU (combinational)</h3>
<div class="paragraph">
<p>The main ALU is responsible for register-register calculation, register-immediate calculations, and address calculations. It does not raise any exceptions. The ALU should be able to perform the following operations on its operands <code>a</code> and <code>b</code>, to produce result <code>r</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>addition: <code>r = a + b</code></p>
</li>
<li>
<p>subtraction: <code>r = a - b</code></p>
</li>
<li>
<p>and: <code>r = a &amp; b</code></p>
</li>
<li>
<p>or: <code>r = a | b</code></p>
</li>
<li>
<p>xor: <code>r = a ^ b</code></p>
</li>
<li>
<p>shift left: <code>r = a &lt;&lt; b</code></p>
</li>
<li>
<p>shift right (logical): <code>r = a &gt;&gt; b</code></p>
</li>
<li>
<p>shift right (arithmetic): <code>r = a &gt;&gt;&gt; b</code></p>
</li>
<li>
<p>set if less than (unsigned): <code>r = a &lt; b (unsigned)? 1 : 0</code></p>
</li>
<li>
<p>set if less than (signed): <code>r = a &lt; b (signed)? 1 : 0</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The only required flag is <code>zero</code>, for use by <code>beq</code> and <code>bne</code> instructions. Other conditional branch instructions can use <code>r[0]</code> with the operation set-if-less-than (signed/unsigned).</p>
</div>
<div class="paragraph">
<p>The signature for the <code>alu</code> module used for the <code>main_alu</code> component is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-c1">/// Arithmetic Control Unit</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// This is a purely combinational ALU implementation.</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// The operation depends on the 4-bit alu_op as</span>
<span class="tok-c1">/// follows:</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// 0_000: r = a + b</span>
<span class="tok-c1">/// 1_000: r = a - b</span>
<span class="tok-c1">/// 0_001: r = a &lt;&lt; b</span>
<span class="tok-c1">/// x_010: r = a &lt; b ? 1 : 0</span>
<span class="tok-c1">/// x_011: r = signed(a) &lt; signed(b) ? 1 : 0</span>
<span class="tok-c1">/// x_100: r = a ^ b</span>
<span class="tok-c1">/// 0_101: r = a &gt;&gt; b</span>
<span class="tok-c1">/// 1_101: r = signed(a) &gt;&gt;&gt; signed(b)</span>
<span class="tok-c1">/// x_110: r = a | b</span>
<span class="tok-c1">/// x_111: r = a &amp; b</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// The separation in alu_op indicates that the top bit</span>
<span class="tok-c1">/// comes form bit 30 of the instruction, and the bottom</span>
<span class="tok-c1">/// 3 bits come from funct3, in R-type register-register</span>
<span class="tok-c1">/// instructions.</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// For I-type register-immediate instructions, ensure</span>
<span class="tok-c1">/// that the top bit is 0 for addi, slti, sltiu, xori</span>
<span class="tok-c1">/// ori, and andi. For slli, srli, and srai, set the top</span>
<span class="tok-c1">/// bit to bit 30 of the instruction, and set b to the</span>
<span class="tok-c1">/// shift amount (shamt) field. Set the low three</span>
<span class="tok-c1">/// bits to funct3 in all cases.</span>
<span class="tok-c1">///</span>
<span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">alu</span><span class="tok-p">(</span>
<span class="tok-w">    </span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">a</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// First 32-bit operand</span>
<span class="tok-w">    </span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">b</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// Second 32-bit operand</span>
<span class="tok-w">    </span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">3</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">alu_op</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// ALU control signals (see comments above)</span>
<span class="tok-w">    </span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">r</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 32-bit result</span>
<span class="tok-w">    </span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">zero</span><span class="tok-w"> </span><span class="tok-c1">// 1 if r is zero, 0 otherwise</span>
<span class="tok-w">    </span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An instance of the <code>alu</code> module will also be used for the <code>next_pc</code> calculation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_register_file_sequential">Register file (sequential)</h3>
<div class="paragraph">
<p>The register file has two combinational read ports and one sequential write port. The register file does not raise exceptions. The signature of the register file is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-c1">/// 32-bit Register file</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// There are 32 32-bit registers x0-x31, with x0 hardwired</span>
<span class="tok-c1">/// to zero. This module provides two combinational output</span>
<span class="tok-c1">/// ports, controlled by the two addresses rs1 and src, and</span>
<span class="tok-c1">/// a single registered write (on the rising edge of the clock</span>
<span class="tok-c1">/// when the write enable signal is asserted).</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// There is no reset; on power-on, the register values are</span>
<span class="tok-c1">/// set to zero.</span>
<span class="tok-c1">///</span>
<span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">register_file</span><span class="tok-p">(</span>
<span class="tok-w">    </span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">clk</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// clock</span>
<span class="tok-w">    </span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">write_en</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// write enable</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">write_data</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// data for write</span>
<span class="tok-w">    </span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">4</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">rs1</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// source register index A</span>
<span class="tok-w">    </span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">4</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">rs2</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// source register index B</span>
<span class="tok-w">    </span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">4</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">rd</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// destination register index for write</span>
<span class="tok-w">    </span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">rs1_data</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// read port A</span>
<span class="tok-w">    </span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">rs2_data</span><span class="tok-w"> </span><span class="tok-c1">// read port B</span>
<span class="tok-w">    </span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_path_multiplexers">Data path (multiplexers)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains the designs for signal selection multiplexers at the inputs to most of the data path modules. They are named using the format <code>&lt;module_name&gt;_&lt;input_name&gt;_sel</code> where <code>&lt;module_name&gt;</code> and <code>&lt;input_name&gt;</code> specifies which signal of which module is being driven. The control signals for each multiplexer come from the control unit. Sometimes, the module may contain logic in addition to a multiplexer for generating the input signal.</p>
</div>
<div class="paragraph">
<p>Some signals do not require multiplexers, because they are always taken from the same source. The signals corresponding to register indices are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>register_file_rs1</code> is always tied to the <code>rs1</code> field of the instructions (<code>instr[19:15]</code>)</p>
</li>
<li>
<p><code>register_file_rs2</code> is always tied to the <code>rs2</code> field of the instructions (<code>instr[24:20]</code>)</p>
</li>
<li>
<p><code>register_file_rd</code> is always tied to the <code>rd</code> field of the instructions (<code>instr[11:7]</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It does not matter if these fields are not used in the instruction, and therefore contains junk; in these cases, <code>register_file_write_en</code> is de-asserted, and the combinational outputs <code>rs1_data</code> and <code>rs2_data</code> are ignored.</p>
</div>
<div class="paragraph">
<p>Only the load and store instructions can read or write to the data memory bus, which means the following signals are always routed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>data memory bus <code>addr</code> always comes from the main ALU result <code>r</code></p>
</li>
<li>
<p>data memory bus <code>width</code> field is calculated statically from the instruction</p>
</li>
<li>
<p>data memory bus <code>write_data</code> is routed from <code>rs2_data</code> from the register file</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The multiplexers that select between different potential inputs are outlined below.</p>
</div>
<div class="sect2">
<h3 id="_main_alu_input_ports">Main ALU input ports</h3>
<div class="paragraph">
<p>There are two multiplexers which control the input ports to the main ALU: <code>main_alu_a_sel</code> and <code>main_alu_b_sel</code>. The following guidelines have been followed when selecting which signals is routed to which port of the main ALU:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>rs1_data</code> and <code>rs2_data</code> are routed to ports <code>a</code> and <code>b</code> of the ALU</p>
</li>
<li>
<p>immediate fields are typically routed to port <code>b</code> of the ALU</p>
</li>
<li>
<p>the <code>pc</code> is routed to the first port of the ALU if it is needed</p>
</li>
<li>
<p>the CSR-bus data output is routed to port <code>b</code> of the main ALU; for CSR instructions, port <code>a</code> is used for <code>rs1_data</code>, <code>!rs1_data</code>, and the <code>uimm</code>-derived immediates.</p>
</li>
<li>
<p>the CSR-bus address is always routed from the <code>csr</code> field in the CSR instruction format (<code>instr[31:20]</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The signatures for the two ALU input multiplexers are as follows. The first port is controlled by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-c1">/// Selects the signal input for port a of the main ALU</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// The sel argument selects between the inputs (sel is in binary):</span>
<span class="tok-c1">///  000: rs1_data, for register-register, register-immediate,</span>
<span class="tok-c1">///  branch, load, store instructions</span>
<span class="tok-c1">///  001: pc, for auipc and jal instructions</span>
<span class="tok-c1">///  010: 0, for lui</span>
<span class="tok-c1">///  011: !rs1_data, for use in CSR instructions</span>
<span class="tok-c1">///  100: uimm, for use in CSR instructions</span>
<span class="tok-c1">///  101: !uimm, for use in CSR instructions</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// When uimm is negated, the negation happens _before_ the</span>
<span class="tok-c1">/// sign-extension to 32-bits.</span>
<span class="tok-c1">///</span>
<span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">main_alu_a_sel</span><span class="tok-p">(</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">2</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">sel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// chooses the output signal</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">rs1_data</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// the value of rs1 from the register file</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">pc</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// for current program counter</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">4</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">uimm</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// uimm field from CSR instructions</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">a</span><span class="tok-w"> </span><span class="tok-c1">// the main ALU a signal</span>
<span class="tok-w">	</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The second port is controlled by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-c1">/// Selects the signal input for port b of the main ALU</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// The sel argument selects between the inputs (sel is in binary):</span>
<span class="tok-c1">///  00: rs2_data, for register-register, branch instructions</span>
<span class="tok-c1">///  01: imm, for register-immediate, load, store, jal, jalr,</span>
<span class="tok-c1">///  10: csr_read_data, for CSR instructions</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// The imm argument above needs generating according to whichever</span>
<span class="tok-c1">/// instruction is being implemented; different instructions have</span>
<span class="tok-c1">/// different formats for the immediate, and need it to be processsed</span>
<span class="tok-c1">/// in different ways. The imm argument will be passed straight</span>
<span class="tok-c1">/// through to b unprocessed.</span>
<span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">main_alu_b_sel</span><span class="tok-p">(</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">1</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">sel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// chooses the output signal</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">rs2_data</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// the value of rs2 from the register file</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">imm</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// immediate field, already extracted/sign-extended</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">b</span><span class="tok-w"> </span><span class="tok-c1">// the main ALU b signal</span>
<span class="tok-w">	</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_register_file_write_data">Register file write data</h3>
<div class="paragraph">
<p>The <code>write_data</code> signal for writing to <code>rd</code> is selected from multiple sources depending on the instruction. The module is given below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-c1">/// Write data for rd in register file</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// The sel arguments selects between the inputs (sel is in binary):</span>
<span class="tok-c1">///  00: main_alu_r, for register-register, register-immediate,</span>
<span class="tok-c1">///  and lui/auipc instructions</span>
<span class="tok-c1">///  01: for load instructions</span>
<span class="tok-c1">///  10: csr_bus_out, for all CSR instructions</span>
<span class="tok-c1">///  11: pc + 4, for jal/jalr instructions</span>
<span class="tok-c1">///</span>
<span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">register_file_write_data_sel</span><span class="tok-p">(</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">1</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">sel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// choose the output signal</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">main_alu_r</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// the output from the main ALU</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">data_mem_out</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// data output from data memory bus</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">csr_bus_out</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// data output from CSR bus</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">pc_plus_4</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// current pc + 4, from next_pc_sel</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">write_data</span><span class="tok-w"> </span><span class="tok-c1">//</span>
<span class="tok-w">	</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_next_program_counter">Next program counter</h3>
<div class="paragraph">
<p>The next program counter <code>next_pc</code> is either calculated directly, or is the output from an ALU, configured as an adder, whose input <code>B</code> is controlled by a multiplexer. The configuration of the calculation is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>A = pc</code>, <code>B = 4</code>: most instructions</p>
</li>
<li>
<p><code>A = pc</code>, <code>B = offset</code>: control flow instructions; <code>offset</code> is</p>
<div class="ulist">
<ul>
<li>
<p>obtained from sign extending <code>imm</code> fields in instruction (branch instructions)</p>
</li>
<li>
<p>output from <code>main_alu</code> for <code>jal</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>A = exception_vector</code>, <code>B = interrupt_offset</code>: for exceptions and interrupts</p>
</li>
<li>
<p><code>next_pc = 0xffff_fffe &amp; jalr_target</code>: for <code>jalr</code> instructions, <code>jalr_target</code> is the output from <code>main_alu</code>. It needs the bottom bit masking out.</p>
</li>
<li>
<p><code>next_pc = mepc</code>: <code>mret</code> instruction only</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The output from this adder is checked for instruction alignment (multiple of 4). If the <code>pc</code> is not four-byte aligned, an <code>InstructionAddressMisaligned</code> exception is raised.</p>
</div>
<div class="paragraph">
<p>The module that will calculate the <code>pc</code> is called <code>next_pc</code>, and has the following signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="verilog"><span></span><span class="tok-c1">/// Combinational module to calculate the next value of</span>
<span class="tok-c1">/// the program counter. The control signal sel sets</span>
<span class="tok-c1">/// the calculation of maybe_next_pc as follows:</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// 00: pc + 4</span>
<span class="tok-c1">/// 01: mepc</span>
<span class="tok-c1">/// 10: 32&#39;hffff_fffe &amp; jalr_target</span>
<span class="tok-c1">/// 11: pc + offset</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// The control line trap decides whether maybe_next_pc</span>
<span class="tok-c1">/// becomes the next_pc or not:</span>
<span class="tok-c1">///</span>
<span class="tok-c1">///                       trap</span>
<span class="tok-c1">///                        |</span>
<span class="tok-c1">/// maybe_next_pc --------</span>
<span class="tok-c1">///                       MUX ----- next_pc</span>
<span class="tok-c1">/// trap_pc --------------</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// where trap_pc = exception_vector + interrupt_offset</span>
<span class="tok-c1">///</span>
<span class="tok-c1">/// If the maybe_next_pc is not a multiple of 4 when adding</span>
<span class="tok-c1">/// offset or using jalr_target (i.e. pc_src 01 or</span>
<span class="tok-c1">/// 10), then InstructionAddressMisaligned exception</span>
<span class="tok-c1">/// is raised (indicated by instr_addr_mis set). This should</span>
<span class="tok-c1">/// cause an external control system to set trap. It is</span>
<span class="tok-c1">/// important that the instr_addr_mis signal continues to</span>
<span class="tok-c1">/// be asserted even after trap is set, which is why</span>
<span class="tok-c1">/// maybe_next_pc is separate from next_pc (this allows</span>
<span class="tok-c1">/// a fully combinational single-cycle design).</span>
<span class="tok-c1">///</span>
<span class="tok-k">module</span><span class="tok-w"> </span><span class="tok-n">next_pc_sel</span><span class="tok-p">(</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">1</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">sel</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// select the next pc for normal program flow</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">pc</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// the current value of the PC</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">mepc</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// the pc to use for mret</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">exception_vector</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// from mtvec</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">interrupt_offset</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 0 for exception; for interrupt, specify byte offset to trap vector</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">offset</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// offset to add to the current pc</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">jalr_target</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// un-masked jalr target PC</span>
<span class="tok-w">	</span><span class="tok-k">input</span><span class="tok-w"> </span><span class="tok-n">trap</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// 0 for normal program flow, 1 for trap</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">pc_plus_4</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// this signal is written to rd for jal/jalr</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-mh">31</span><span class="tok-o">:</span><span class="tok-mh">0</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-n">next_pc</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// the next value to load into pc</span>
<span class="tok-w">	</span><span class="tok-k">output</span><span class="tok-w"> </span><span class="tok-n">instr_addr_mis</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-c1">// flag for instruction address misaligned exception</span>
<span class="tok-w">	</span><span class="tok-p">);</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-12-22 12:10:51 UTC
</div>
</div>
</body>
</html>